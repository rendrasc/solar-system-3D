<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cosmos Explorer 3D</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM (via ESM for browser) -->
    <script type="importmap">
        {
            "imports": {
                "react": "https://esm.sh/react@18.2.0",
                "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
                "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js",
                "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/"
            }
        }
    </script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        /* Custom Scrollbar hide */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        .fade-mask {
            mask-image: linear-gradient(to right, transparent, black 10%, black 90%, transparent);
            -webkit-mask-image: linear-gradient(to right, transparent, black 10%, black 90%, transparent);
        }
    </style>
</head>
<body class="bg-black text-white overflow-hidden m-0 p-0">
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useRef } from 'react';
        import { createRoot } from 'react-dom/client';
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';

        // --- ICONS (SVG replacements for Lucide) ---
        const IconBase = ({ children, size = 24, className = "" }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{children}</svg>
        );
        const Loader2 = (props) => <IconBase {...props}><path d="M21 12a9 9 0 1 1-6.219-8.56" /></IconBase>;
        const X = (props) => <IconBase {...props}><path d="M18 6 6 18"/><path d="m6 6 18 18"/></IconBase>;
        const PlayCircle = (props) => <IconBase {...props}><circle cx="12" cy="12" r="10"/><polygon points="10 8 16 12 10 16 10 8"/></IconBase>;
        const Pause = (props) => <IconBase {...props}><rect x="6" y="4" width="4" height="16"/><rect x="14" y="4" width="4" height="16"/></IconBase>;
        const Layers = (props) => <IconBase {...props}><polygon points="12 2 2 7 12 12 22 7 12 2"/><polyline points="2 17 12 22 22 17"/><polyline points="2 12 12 17 22 12"/></IconBase>;
        const ScanEye = (props) => <IconBase {...props}><path d="M3 7V5a2 2 0 0 1 2-2h2"/><path d="M17 3h2a2 2 0 0 1 2 2v2"/><path d="M21 17v2a2 2 0 0 1-2 2h-2"/><path d="M7 21H5a2 2 0 0 1-2-2v-2"/><circle cx="12" cy="12" r="1"/><path d="M5 12h7"/><path d="M12 5v7"/></IconBase>; // Simplified ScanEye
        const ArrowRight = (props) => <IconBase {...props}><path d="M5 12h14"/><path d="m12 5 7 7-7 7"/></IconBase>;
        const MessageSquare = (props) => <IconBase {...props}><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></IconBase>;
        const ChevronDown = (props) => <IconBase {...props}><path d="m6 9 6 6 6-6"/></IconBase>;
        const ChevronUp = (props) => <IconBase {...props}><path d="m18 15-6-6-6 6"/></IconBase>;
        const Volume2 = (props) => <IconBase {...props}><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><path d="M15.54 8.46a5 5 0 0 1 0 7.07"/><path d="M19.07 4.93a10 10 0 0 1 0 14.14"/></IconBase>;
        const VolumeX = (props) => <IconBase {...props}><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><line x1="23" x2="17" y1="9" y2="15"/><line x1="17" x2="23" y1="9" y2="15"/></IconBase>;

        /**
         * --- DATA & CONSTANTS ---
         */
        const REPO_URL = "https://raw.githubusercontent.com/rendrasc/solar-system-3D/main/textures";
        const AUDIO_IDLE_URL = "https://raw.githubusercontent.com/rendrasc/solar-system-3D/main/audio/horizon_X01.mp3";
        const AUDIO_TOUR_URL = "https://raw.githubusercontent.com/rendrasc/solar-system-3D/main/audio/horizon_journey_01.mp3";

        const SOLAR_DATA = [
            { 
                id: 'sun', name: "Sun", type: "Star", radius: 35, distance: 0, speed: 0, color: '#FFD700', textureType: 'star', 
                textureUrl: `${REPO_URL}/sun.jpg`,
                stats: { temp: '5,500¬∞C', orbit: 'N/A', gravity: '274 m/s¬≤', day: '25 Days' }, 
                comp: ['Hydrogen', 'Helium'], 
                desc: "The star at the center of our Solar System.", 
                narration: "The Sun is the colossal powerhouse...",
                facts: [ "Accounts for 99.86% of solar system mass.", "Light takes 8 mins to reach Earth.", "Core is ~15 million degrees Celsius." ]
            },
            { 
                id: 'mercury', name: "Mercury", type: "Planet", radius: 2.8, distance: 55, speed: 0.015, color: '#999999', textureType: 'mercury',
                textureUrl: `${REPO_URL}/mercury.jpg`,
                stats: { temp: '167¬∞C', orbit: '88 Days', gravity: '3.7 m/s¬≤', day: '59 Days' }, 
                comp: ['Iron', 'Sodium'], 
                desc: "The smallest planet in the Solar System.", 
                narration: "Mercury is the smallest planet...",
                facts: [ "Shrinks as it cools.", "Temp swings from 430¬∞C to -180¬∞C.", "Most cratered planet." ] 
            },
            { 
                id: 'venus', name: "Venus", type: "Planet", radius: 6.5, distance: 80, speed: 0.012, color: '#E3BB76', textureType: 'venus', 
                textureUrl: `${REPO_URL}/venus.jpg`,
                stats: { temp: '464¬∞C', orbit: '225 Days', gravity: '8.87 m/s¬≤', day: '243 Days' }, 
                comp: ['CO2', 'Nitrogen'], 
                desc: "Hottest planet due to greenhouse effect.", 
                narration: "Venus is often called Earth's twin...",
                facts: [ "Hottest planet in the solar system.", "Spins backwards.", "Named after goddess of love." ] 
            },
            { 
                id: 'earth', name: "Earth", type: "Planet", radius: 7, distance: 110, speed: 0.01, color: '#1C4E80', textureType: 'earth',
                textureUrl: `${REPO_URL}/earth.jpg`,
                stats: { temp: '15¬∞C', orbit: '365 Days', gravity: '9.8 m/s¬≤', day: '24 Hours' }, 
                comp: ['Nitrogen', 'Oxygen'], 
                desc: "The only known world to harbor life.", 
                narration: "Earth is our home...",
                facts: [ "Only place known to host life.", "Densest planet.", "70% surface is water." ], 
                moons: [{ name: "Moon", radius: 1.9, distance: 14, speed: 0.03, color: '#E0E0E0', type: 'rocky', textureUrl: `${REPO_URL}/moon.jpg` }] 
            },
            { 
                id: 'mars', name: "Mars", type: "Planet", radius: 3.8, distance: 150, speed: 0.008, color: '#D14A28', textureType: 'mars', 
                textureUrl: `${REPO_URL}/mars.jpg`,
                stats: { temp: '-65¬∞C', orbit: '687 Days', gravity: '3.71 m/s¬≤', day: '24.6 Hours' }, 
                comp: ['CO2', 'Argon'], 
                desc: "The Red Planet.", 
                narration: "Mars, the Red Planet...",
                facts: [ "Home to Olympus Mons.", "Has largest dust storms.", "Red color is rust." ], 
                moons: [{ name: "Phobos", radius: 0.6, distance: 8, speed: 0.05, color: '#887766' }, { name: "Deimos", radius: 0.4, distance: 12, speed: 0.03, color: '#776655' }] 
            },
            { 
                id: 'jupiter', name: "Jupiter", type: "Gas Giant", radius: 22, distance: 220, speed: 0.004, color: '#C88B3A', textureType: 'jupiter', 
                textureUrl: `${REPO_URL}/jupiter.jpg`,
                stats: { temp: '-110¬∞C', orbit: '12 Years', gravity: '24.79 m/s¬≤', day: '10 Hours' }, 
                comp: ['Hydrogen', 'Helium'], 
                desc: "The largest planet.", 
                narration: "Jupiter is a gas giant...",
                facts: [ "Great Red Spot is a storm.", "Shortest day of all planets.", "Mass is 2.5x all others combined." ], 
                moons: [{ name: "Io", radius: 1.8, distance: 30, speed: 0.04, color: '#F8F189' }, { name: "Europa", radius: 1.6, distance: 35, speed: 0.03, color: '#C6D2D8' }, { name: "Ganymede", radius: 2.6, distance: 42, speed: 0.02, color: '#968E84' }, { name: "Callisto", radius: 2.4, distance: 50, speed: 0.015, color: '#6E665A' }],
                rings: { inner: 22.8, outer: 23.5, color: 0xa08060, opacity: 0.1 } 
            },
            { 
                id: 'saturn', name: "Saturn", type: "Gas Giant", radius: 18, distance: 300, speed: 0.003, color: '#E4D5B6', textureType: 'saturn',
                textureUrl: `${REPO_URL}/saturn.jpg`,
                rings: { inner: 24, outer: 42, color: 0xcfc3a3, opacity: 0.9 }, 
                stats: { temp: '-140¬∞C', orbit: '29 Years', gravity: '10.44 m/s¬≤', day: '10.7 Hours' }, 
                comp: ['Hydrogen', 'Helium'], 
                desc: "Famous for its rings.", 
                narration: "Saturn is the jewel...",
                facts: [ "Rings are made of ice.", "Least dense planet (floats).", "Most moons (146)." ], 
                moons: [{ name: "Titan", radius: 2.5, distance: 40, speed: 0.02, color: '#E8D586' }, { name: "Rhea", radius: 0.8, distance: 25, speed: 0.03, color: '#B0B0B0' }] 
            },
            { 
                id: 'uranus', name: "Uranus", type: "Ice Giant", radius: 12, distance: 380, speed: 0.002, color: '#93B8BE', textureType: 'uranus', tilt: Math.PI / 2,
                textureUrl: `${REPO_URL}/uranus.jpg`,
                rings: { inner: 14, outer: 18, color: 0x88aabb, opacity: 0.2 },
                stats: { temp: '-195¬∞C', orbit: '84 Years', gravity: '8.69 m/s¬≤', day: '17 Hours' }, 
                comp: ['Hydrogen', 'Ices'], 
                desc: "Rotates on its side.", 
                narration: "Uranus is an ice giant...",
                facts: [ "Rotates on its side.", "Coldest planetary atmosphere.", "Retrograde rotation." ], 
                moons: [{ name: "Titania", radius: 0.9, distance: 20, speed: 0.03, color: '#D0C0B0' }] 
            },
            { 
                id: 'neptune', name: "Neptune", type: "Ice Giant", radius: 11.5, distance: 450, speed: 0.001, color: '#5B80ED', textureType: 'neptune', 
                textureUrl: `${REPO_URL}/neptune.jpg`,
                stats: { temp: '-200¬∞C', orbit: '165 Years', gravity: '11.15 m/s¬≤', day: '16 Hours' }, 
                comp: ['Hydrogen', 'Ices'], 
                desc: "The windiest planet.", 
                narration: "Neptune is a dark...",
                facts: [ "Supersonic winds (2000 km/h).", "Predicted by math first.", "Blue color from methane." ], 
                moons: [{ name: "Triton", radius: 1.4, distance: 18, speed: 0.03, color: '#E0D0C0' }] 
            },
            { 
                id: 'pluto', name: "Pluto", type: "Dwarf Planet", radius: 1.8, distance: 585, speed: 0.0008, color: '#D1C2A5', textureType: 'rocky',
                textureUrl: `${REPO_URL}/pluto.jpg`,
                stats: { temp: '-229¬∞C', orbit: '248 Years', gravity: '0.62 m/s¬≤', day: '153 Hours' }, 
                comp: ['Nitrogen', 'Methane'], 
                desc: "The famous dwarf planet.", 
                narration: "Pluto, once considered...",
                facts: [ "Reclassified as dwarf planet.", "Has a heart-shaped glacier.", "Atmosphere freezes." ], 
                moons: [{ name: "Charon", radius: 0.9, distance: 5, speed: 0.01, color: '#A0A0A0' }]
            },
            { 
                id: 'haumea', name: "Haumea", type: "Dwarf Planet", radius: 2.0, distance: 645, speed: 0.0006, color: '#E0E0E0', textureType: 'rocky', 
                textureUrl: `${REPO_URL}/haumea.jpg`,
                scale: [1.9, 0.9, 0.5], 
                stats: { temp: '-241¬∞C', orbit: '284 Years', gravity: '0.4 m/s¬≤', day: '4 Hours' }, 
                comp: ['Rock', 'Ice'], 
                desc: "The egg-shaped spinner.", 
                narration: "Haumea is a unique...",
                facts: [ "Spins once every 4 hours.", "Shaped like an egg.", "Covered in crystalline ice." ]
            }
        ];

        // --- APP COMPONENT ---
        function App() {
            const mountRef = useRef(null);
            
            const [loading, setLoading] = useState(true);
            const [selectedPlanet, setSelectedPlanet] = useState(null);
            const [isTouring, setIsTouring] = useState(false);
            const [isPaused, setIsPaused] = useState(false);
            const [structureMode, setStructureMode] = useState(false);
            const [isNavOpen, setIsNavOpen] = useState(true);
            const [isMuted, setIsMuted] = useState(false);
            
            const [isIdle, setIsIdle] = useState(false);
            const idleTimerRef = useRef(null);
            const audioRef = useRef(null);

            const sceneRef = useRef(null);
            const cameraRef = useRef(null);
            const rendererRef = useRef(null);
            const controlsRef = useRef(null);
            const objectsRef = useRef([]);
            const interactablesRef = useRef([]);
            const tourTimerRef = useRef(null);
            const tourIndexRef = useRef(-1);
            const isTouringRef = useRef(false);
            const activeTargetRef = useRef(null);

            // --- AUDIO LOGIC ---
            const resetIdleTimer = () => {
                setIsIdle(false);
                if (idleTimerRef.current) clearTimeout(idleTimerRef.current);
                idleTimerRef.current = setTimeout(() => {
                    setIsIdle(true);
                }, 10000); 
            };

            useEffect(() => {
                window.addEventListener('mousemove', resetIdleTimer);
                window.addEventListener('mousedown', resetIdleTimer);
                window.addEventListener('keydown', resetIdleTimer);
                window.addEventListener('touchstart', resetIdleTimer);
                
                resetIdleTimer(); 

                return () => {
                    window.removeEventListener('mousemove', resetIdleTimer);
                    window.removeEventListener('mousedown', resetIdleTimer);
                    window.removeEventListener('keydown', resetIdleTimer);
                    window.removeEventListener('touchstart', resetIdleTimer);
                    if (idleTimerRef.current) clearTimeout(idleTimerRef.current);
                };
            }, []);

            useEffect(() => {
                if (!audioRef.current) {
                    audioRef.current = new Audio();
                    audioRef.current.loop = true;
                    audioRef.current.volume = 0.5;
                }

                const audio = audioRef.current;
                
                if (isMuted) {
                    audio.pause();
                    return;
                }

                const playAudio = (src) => {
                    if (audio.src !== src) {
                        audio.src = src;
                        audio.play().catch(e => console.log("Audio interaction needed:", e));
                    } else if (audio.paused) {
                        audio.play().catch(e => console.log("Audio interaction needed:", e));
                    }
                };

                if (isTouring) {
                    playAudio(AUDIO_TOUR_URL);
                } else if (isIdle) {
                    playAudio(AUDIO_IDLE_URL);
                } else {
                    audio.pause();
                }
            }, [isIdle, isTouring, isMuted]);

            // --- 3D SCENE ---
            useEffect(() => {
                const scene = new THREE.Scene();
                scene.background = new THREE.Color(0x000000);
                scene.fog = new THREE.FogExp2(0x000000, 0.0008);
                sceneRef.current = scene;

                const camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 10000);
                camera.position.set(0, 150, 600);
                cameraRef.current = camera;

                const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: false, logarithmicDepthBuffer: true, powerPreference: "high-performance" });
                renderer.setSize(window.innerWidth, window.innerHeight);
                renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
                renderer.toneMapping = THREE.ACESFilmicToneMapping;
                renderer.toneMappingExposure = 2.2;
                mountRef.current.appendChild(renderer.domElement);
                rendererRef.current = renderer;

                const controls = new OrbitControls(camera, renderer.domElement);
                controls.enableDamping = true;
                controls.dampingFactor = 0.05;
                controls.minDistance = 20;
                controls.maxDistance = 3000;
                controlsRef.current = controls;

                // Lighting
                const hemiLight = new THREE.HemisphereLight(0xffffe0, 0x000000, 0.15); 
                scene.add(hemiLight);
                const ambientLight = new THREE.AmbientLight(0x404040, 0.8); 
                scene.add(ambientLight);
                const sunLight = new THREE.PointLight(0xffffff, 10.0, 0, 0); 
                sunLight.position.set(0, 0, 0);
                scene.add(sunLight);

                // Texture Generator (Fallback)
                function generateTexture(type, colorHex, isRoughnessMap = false) {
                    const isPlanetMap = ['earth', 'mercury', 'venus', 'mars', 'jupiter', 'saturn', 'uranus', 'neptune', 'rocky', 'atmosphere', 'galaxy'].includes(type);
                    const sizeW = 2048; const sizeH = isPlanetMap ? 1024 : 2048; 
                    const canvas = document.createElement('canvas');
                    canvas.width = sizeW; canvas.height = sizeH;
                    const ctx = canvas.getContext('2d');
                    const w = sizeW; const h = sizeH;
                    const baseColor = new THREE.Color(colorHex);
                    
                    const drawNoiseLayer = (scale, alpha, blendMode = 'source-over', color = null) => {
                        const count = 300 * scale;
                        ctx.globalCompositeOperation = blendMode;
                        for(let i=0; i<count; i++) {
                            const x = Math.random() * w; const y = Math.random() * h; const radius = (Math.random() * 50 + 20) / scale;
                            ctx.beginPath(); ctx.arc(x, y, radius, 0, Math.PI*2);
                            ctx.fillStyle = color || `rgba(255,255,255,${alpha})`; ctx.fill();
                        }
                        ctx.globalCompositeOperation = 'source-over';
                    };

                    if (type === 'earth') {
                        ctx.fillStyle = isRoughnessMap ? '#111111' : '#0a1a33'; 
                        ctx.fillRect(0,0,w,h);
                        return new THREE.CanvasTexture(canvas);
                    }
                    if (type === 'star') {
                        const grd = ctx.createRadialGradient(w/2, h/2, 0, w/2, h/2, w/2); 
                        grd.addColorStop(0, '#FFFFFF'); grd.addColorStop(0.3, '#FFFFAA'); grd.addColorStop(1, colorHex); 
                        ctx.fillStyle = grd; ctx.fillRect(0,0,w,h);
                        drawNoiseLayer(0.5, 0.2, 'overlay', '#ffaa00');
                    } else if (type === 'glow') {
                        const grd = ctx.createRadialGradient(w/2, h/2, 0, w/2, h/2, w/2);
                        grd.addColorStop(0, '#FFFFFF'); grd.addColorStop(0.2, '#FFFFAA'); grd.addColorStop(0.5, colorHex); grd.addColorStop(1, 'rgba(0,0,0,0)');
                        ctx.fillStyle = grd; ctx.fillRect(0,0,w,h);
                    } else if (type === 'galaxy') {
                        ctx.fillStyle = '#050510'; ctx.fillRect(0,0,w,h);
                        for(let i=0; i<3; i++) {
                            ctx.filter = `blur(${30 + i*10}px)`; ctx.globalCompositeOperation = 'screen';
                            drawNoiseLayer(0.5, 0.1, 'screen', `hsl(${Math.random()*60+200}, 60%, 40%)`);
                        }
                        ctx.filter = 'none';
                    } else if (type === 'ring') {
                        ctx.fillStyle = '#00000000'; ctx.clearRect(0,0,w,h);
                        const centerX = w/2; const centerY = h/2; const outerRadius = w * 0.5; const innerRadius = w * 0.2; 
                        const grd = ctx.createRadialGradient(centerX, centerY, innerRadius, centerX, centerY, outerRadius);
                        const r = Math.floor(baseColor.r * 255); const g = Math.floor(baseColor.g * 255); const b = Math.floor(baseColor.b * 255);
                        grd.addColorStop(0, `rgba(${r}, ${g}, ${b}, 0)`); grd.addColorStop(0.2, `rgba(${r}, ${g}, ${b}, 0.1)`); 
                        grd.addColorStop(0.5, `rgba(${r}, ${g}, ${b}, 0.8)`); grd.addColorStop(1, `rgba(${r}, ${g}, ${b}, 0)`);
                        ctx.fillStyle = grd; ctx.beginPath(); ctx.arc(centerX, centerY, outerRadius, 0, Math.PI * 2); ctx.fill();
                    } else { // Generic
                         ctx.fillStyle = colorHex; ctx.fillRect(0,0,w,h);
                         ctx.globalCompositeOperation = 'multiply';
                         for(let i=0; i<5000; i++) {
                             const s = Math.random() * 80 + 100; ctx.fillStyle = `rgb(${s},${s},${s})`;
                             ctx.globalAlpha = 0.3; ctx.fillRect(Math.random()*w, Math.random()*h, 2, 2);
                         }
                         ctx.globalAlpha = 1.0;
                    }
                    return new THREE.CanvasTexture(canvas);
                }
                
                // Sun Glow Sprites
                const spriteMaterial = new THREE.SpriteMaterial({ 
                    map: generateTexture('glow', '#FFD700'), color: 0xFFD700, transparent: true, blending: THREE.AdditiveBlending, opacity: 0.5, depthWrite: false
                });
                const sunSprite = new THREE.Sprite(spriteMaterial);
                sunSprite.scale.set(150, 150, 1.0); 
                scene.add(sunSprite);
                
                const coronaMaterial = new THREE.SpriteMaterial({ 
                    map: generateTexture('glow', '#ffaa00'), color: 0xffaa00, transparent: true, blending: THREE.AdditiveBlending, opacity: 0.2, depthWrite: false
                });
                const coronaSprite = new THREE.Sprite(coronaMaterial);
                coronaSprite.scale.set(300, 300, 1.0); 
                scene.add(coronaSprite);

                // Background
                const bgGeo = new THREE.SphereGeometry(4000, 32, 32);
                const bgMat = new THREE.MeshBasicMaterial({ map: generateTexture('galaxy', '#000000'), side: THREE.BackSide, transparent: true, opacity: 0.3 });
                scene.add(new THREE.Mesh(bgGeo, bgMat));

                // Stars
                const starGeo = new THREE.BufferGeometry();
                const starCount = 6000;
                const starPos = new Float32Array(starCount * 3);
                const starColors = new Float32Array(starCount * 3);
                const col = new THREE.Color();
                for(let i=0; i<starCount*3; i+=3) {
                    const r = 1000 + Math.random() * 1000;
                    const theta = 2 * Math.PI * Math.random();
                    const phi = Math.acos(2 * Math.random() - 1);
                    starPos[i] = r * Math.sin(phi) * Math.cos(theta);
                    starPos[i+1] = r * Math.sin(phi) * Math.sin(theta);
                    starPos[i+2] = r * Math.cos(phi);
                    if(Math.random()>0.9) col.setHex(0xffaaaa); else col.setHex(0xffffff);
                    starColors[i] = col.r; starColors[i+1] = col.g; starColors[i+2] = col.b;
                }
                starGeo.setAttribute('position', new THREE.BufferAttribute(starPos, 3));
                starGeo.setAttribute('color', new THREE.BufferAttribute(starColors, 3));
                const starMat = new THREE.PointsMaterial({ vertexColors: true, size: 1.5, transparent: true, opacity: 0.9, sizeAttenuation: true });
                scene.add(new THREE.Points(starGeo, starMat));

                // Belts
                const createDebrisBelt = (count, minRadius, maxRadius) => {
                    const geo = new THREE.DodecahedronGeometry(0.1, 0); 
                    const mat = new THREE.MeshStandardMaterial({ color: 0xffffff, roughness: 0.8, metalness: 0.1, flatShading: true });
                    const mesh = new THREE.InstancedMesh(geo, mat, count);
                    const dummy = new THREE.Object3D();
                    const c = new THREE.Color();
                    for (let i = 0; i < count; i++) {
                        const angle = Math.random() * Math.PI * 2;
                        const r = Math.sqrt(Math.random() * (maxRadius**2 - minRadius**2) + minRadius**2);
                        dummy.position.set(Math.cos(angle)*r, (Math.random()-0.5)*15*(1-(r-minRadius)/(maxRadius-minRadius)*0.5), Math.sin(angle)*r);
                        dummy.rotation.set(Math.random()*Math.PI, Math.random()*Math.PI, Math.random()*Math.PI);
                        const s = Math.random() * 1.2 + 0.5; dummy.scale.set(s,s,s);
                        dummy.updateMatrix(); mesh.setMatrixAt(i, dummy.matrix);
                        c.setHex(0xb3b3b3); c.offsetHSL(0, 0, (Math.random()-0.5)*0.1); mesh.setColorAt(i, c);
                    }
                    return mesh;
                };
                const kuiperBelt = createDebrisBelt(4000, 500, 850); scene.add(kuiperBelt);
                const asteroidBelt = createDebrisBelt(3000, 170, 210); scene.add(asteroidBelt);

                // Planets
                SOLAR_DATA.forEach((data, index) => {
                    const group = new THREE.Group();
                    let tex;
                    if (data.textureUrl) {
                        tex = new THREE.TextureLoader().load(data.textureUrl);
                        tex.colorSpace = THREE.SRGBColorSpace;
                    } else {
                        tex = generateTexture(data.textureType, data.color, false);
                    }
                    
                    let mat;
                    if (data.type === 'Star') {
                        mat = new THREE.MeshBasicMaterial({ map: tex, color: 0xffffff }); 
                    } else if (data.id === 'earth') {
                        const useProcedural = !data.textureUrl;
                        mat = new THREE.MeshStandardMaterial({ 
                            map: tex, 
                            roughnessMap: useProcedural ? generateTexture('earth', null, true) : null, 
                            roughness: data.textureUrl ? 0.6 : 1.0, metalness: 0.1, envMapIntensity: 1.0, emissive: 0x111111, emissiveIntensity: 0.1
                        });
                    } else {
                        mat = new THREE.MeshStandardMaterial({ 
                            map: tex, roughness: 0.5, metalness: 0.1, emissive: 0x222222, emissiveIntensity: 0.15
                        });
                    }

                    const mesh = new THREE.Mesh(new THREE.SphereGeometry(data.radius, 128, 128), mat);
                    mesh.userData = { id: index, type: 'planet' };
                    if (data.tilt) mesh.rotation.z = data.tilt;
                    if (data.scale) mesh.scale.set(data.scale[0], data.scale[1], data.scale[2]);
                    group.add(mesh);
                    interactablesRef.current.push(mesh);

                    // Moons
                    if (data.moons) {
                        data.moons.forEach((m, mIdx) => {
                            const mGeo = new THREE.SphereGeometry(m.radius, 32, 32);
                            let mTex = m.textureUrl ? new THREE.TextureLoader().load(m.textureUrl) : generateTexture('rocky', m.color);
                            if(m.textureUrl) mTex.colorSpace = THREE.SRGBColorSpace;
                            const mMat = new THREE.MeshStandardMaterial({ map: mTex, roughness: 0.9 });
                            const mMesh = new THREE.Mesh(mGeo, mMat);
                            mMesh.userData = { id: index, moonIndex: mIdx, type: 'moon' };
                            interactablesRef.current.push(mMesh);
                            const mOrbit = new THREE.Group();
                            mOrbit.add(mMesh);
                            mMesh.position.x = m.distance;
                            group.add(mOrbit);
                            // Store moon for animation
                            objectsRef.current.push({ type: 'moon', orbit: mOrbit, mesh: mMesh, speed: m.speed });
                        });
                    }

                    // Rings
                    if (data.rings) {
                        const rGeo = new THREE.RingGeometry(data.rings.inner, data.rings.outer, 128);
                        const rTex = generateTexture('ring', data.rings.color); 
                        const rMat = new THREE.MeshStandardMaterial({ 
                            map: rTex, color: 0xffffff, side: THREE.DoubleSide, transparent: true, opacity: data.rings.opacity || 0.8, roughness: 1.0, metalness: 0.0
                        });
                        const rMesh = new THREE.Mesh(rGeo, rMat);
                        if (data.id === 'uranus') { rMesh.rotation.y = Math.PI / 2; rMesh.rotation.x = 0; } 
                        else { rMesh.rotation.x = Math.PI / 1.8; }
                        group.add(rMesh);
                    }

                    group.position.x = data.distance;
                    scene.add(group);
                    
                    // Orbit Line
                    if (data.distance > 0) {
                        const pts = [];
                        for(let i=0; i<=128; i++) { 
                            const a = (i/128)*Math.PI*2;
                            pts.push(new THREE.Vector3(Math.cos(a)*data.distance, 0, Math.sin(a)*data.distance));
                        }
                        const line = new THREE.Line(new THREE.BufferGeometry().setFromPoints(pts), new THREE.LineBasicMaterial({ color: 0xffffff, opacity: 0.1, transparent: true }));
                        scene.add(line);
                    }

                    objectsRef.current.push({ type: 'planet', group, mesh, data, angle: Math.random()*Math.PI*2 });
                });

                setTimeout(() => setLoading(false), 1000);

                let animationId;
                const animateLoop = () => {
                    animationId = requestAnimationFrame(animateLoop);
                    if (controlsRef.current) controlsRef.current.update();
                    
                    const isPausedVal = renderer.domElement.dataset.paused === 'true';
                    const isStructure = renderer.domElement.dataset.structure === 'true';

                    if (!isPausedVal) {
                        kuiperBelt.rotation.y += 0.00015; 
                        asteroidBelt.rotation.y += 0.0005; 
                    }

                    objectsRef.current.forEach(obj => {
                        if (!isPausedVal) {
                            if (obj.type === 'planet') {
                                if (obj.data.tilt) obj.mesh.rotation.x += 0.003; else obj.mesh.rotation.y += 0.001;
                                if (obj.data.distance > 0) {
                                    obj.angle += obj.data.speed * 0.3;
                                    obj.group.position.x = Math.cos(obj.angle) * obj.data.distance;
                                    obj.group.position.z = Math.sin(obj.angle) * obj.data.distance;
                                }
                            } else if (obj.type === 'moon') {
                                obj.orbit.rotation.y += obj.speed;
                            }
                        }
                        // Structure mode logic for planets
                        if (obj.type === 'planet' && obj.data.type !== 'Star') {
                             if(obj.mesh.material) {
                                 obj.mesh.material.wireframe = isStructure;
                                 obj.mesh.material.opacity = isStructure ? 0.3 : 1;
                                 obj.mesh.material.transparent = isStructure;
                             }
                        }
                    });

                    // Camera Follow
                    if (activeTargetRef.current && !isPausedVal) {
                         const target = activeTargetRef.current;
                         const newPos = new THREE.Vector3();
                         target.mesh.getWorldPosition(newPos);
                         if (!newPos.equals(target.lastPos)) {
                             const delta = new THREE.Vector3().subVectors(newPos, target.lastPos);
                             camera.position.add(delta);
                             controlsRef.current.target.add(delta);
                             target.lastPos.copy(newPos);
                         }
                    }

                    renderer.render(scene, camera);
                };
                animateLoop();

                const handleResize = () => {
                    camera.aspect = window.innerWidth / window.innerHeight;
                    camera.updateProjectionMatrix();
                    renderer.setSize(window.innerWidth, window.innerHeight);
                };
                window.addEventListener('resize', handleResize);

                return () => {
                    cancelAnimationFrame(animationId);
                    window.removeEventListener('resize', handleResize);
                    mountRef.current?.removeChild(renderer.domElement);
                };
            }, []);

            // Event Handlers for React State to DOM data attribs
            useEffect(() => {
                if(rendererRef.current) {
                    rendererRef.current.domElement.dataset.paused = isPaused;
                    rendererRef.current.domElement.dataset.structure = structureMode;
                }
            }, [isPaused, structureMode]);

            return (
                <div className="w-full h-screen bg-black relative text-slate-100 font-sans overflow-hidden">
                    <div ref={mountRef} className="absolute inset-0 z-0 bg-black" />
                    
                    <div className="absolute inset-0 z-10 pointer-events-none flex flex-col justify-between p-6">
                        <header className="flex justify-between items-start pointer-events-auto">
                            <div className="flex items-center gap-4 cursor-pointer group" onClick={resetView}>
                                <div className="w-12 h-12 bg-indigo-600 rounded-2xl flex items-center justify-center shadow-lg group-hover:bg-indigo-500 transition-colors">
                                    <span className="text-2xl">ü™ê</span>
                                </div>
                                <div>
                                    <h1 className="font-bold text-2xl leading-none">COSMOS</h1>
                                    <p className="text-[10px] uppercase text-indigo-400 font-semibold tracking-widest mt-1">Interactive System</p>
                                </div>
                            </div>
                            
                            <div className="flex gap-2 backdrop-blur-sm bg-white/5 p-2 rounded-xl border border-white/10">
                                <button onClick={() => setIsPaused(!isPaused)} className="p-2.5 hover:bg-white/10 rounded-lg transition-colors text-indigo-200 hover:text-white" title={isPaused ? "Play" : "Pause Orbit"}>
                                    {isPaused ? <PlayCircle size={20}/> : <Pause size={20}/>}
                                </button>
                                <button onClick={() => setStructureMode(!structureMode)} className={`p-2.5 rounded-lg transition-colors flex gap-2 items-center ${structureMode ? 'bg-indigo-600 text-white' : 'hover:bg-white/10 text-indigo-200'}`} title="Toggle Wireframe">
                                    <Layers size={20}/>
                                </button>
                                <button onClick={() => setIsMuted(!isMuted)} className={`p-2.5 rounded-lg transition-colors ${isMuted ? 'text-red-400' : 'text-indigo-200 hover:bg-white/10'}`} title="Mute/Unmute">
                                    {isMuted ? <VolumeX size={20}/> : <Volume2 size={20}/>}
                                </button>
                            </div>
                        </header>

                        <div className="absolute bottom-0 left-0 right-0 z-20 flex flex-col justify-end items-center pointer-events-none pb-4">
                            <button onClick={() => setIsNavOpen(!isNavOpen)} className="pointer-events-auto mb-2 bg-white/10 backdrop-blur-md p-1 rounded-full text-indigo-200 hover:text-white transition-all">
                                {isNavOpen ? <ChevronDown size={16} /> : <ChevronUp size={16} />}
                            </button>

                            <div className={`pointer-events-auto max-w-full overflow-x-auto no-scrollbar fade-mask transition-all duration-300 ease-in-out ${isNavOpen ? 'opacity-100 translate-y-0' : 'opacity-0 translate-y-10 pointer-events-none'}`}>
                               <div className="flex gap-2 items-center px-4 bg-black/40 backdrop-blur-xl rounded-2xl border border-white/5 py-2 mx-4">
                                   {isTouring ? (
                                      <button onClick={resetView} className="px-3 py-1.5 bg-red-500/80 backdrop-blur-sm rounded-lg flex items-center gap-1.5 shadow-lg hover:bg-red-500 transition-colors whitespace-nowrap font-semibold border border-red-400/30 text-xs">
                                          <X size={12} /> Stop
                                      </button>
                                   ) : (
                                      <button onClick={startTour} className="px-3 py-1.5 bg-indigo-600/90 backdrop-blur-sm rounded-lg flex items-center gap-1.5 shadow-lg hover:bg-indigo-500 transition-all hover:scale-105 whitespace-nowrap font-semibold border border-indigo-400/30 text-xs">
                                          <ScanEye size={12} /> Tour
                                      </button>
                                   )}
                                   <div className="h-6 w-px bg-white/10 mx-1"></div>
                                   {SOLAR_DATA.map((d, i) => (
                                       <button key={i} onClick={() => focusPlanet(i)} className="flex flex-col items-center gap-1 min-w-[40px] group relative p-1 rounded-lg transition-all hover:bg-white/5">
                                           <div className="w-5 h-5 rounded-full shadow-lg transition-transform group-hover:scale-110 relative bg-cover bg-center" 
                                              style={{ backgroundImage: `url(${d.textureUrl})`, backgroundColor: d.color }}>
                                                {selectedPlanet?.id === d.id && <div className="absolute inset-0 rounded-full ring-1 ring-white animate-pulse"></div>}
                                           </div>
                                           <span className={`text-[7px] font-bold uppercase tracking-wider transition-colors ${selectedPlanet?.id === d.id ? 'text-white' : 'text-zinc-500 group-hover:text-zinc-300'}`}>{d.name}</span>
                                       </button>
                                   ))}
                               </div>
                            </div>
                        </div>
                    </div>

                    <div className={`absolute right-0 top-0 bottom-0 w-full md:w-[450px] bg-black/80 backdrop-blur-xl border-l border-white/10 z-20 p-8 overflow-y-auto transform transition-transform duration-500 ease-out pointer-events-auto ${selectedPlanet ? 'translate-x-0' : 'translate-x-full'}`}>
                        {selectedPlanet && (
                            <>
                                <div className="flex justify-between items-center mb-8">
                                    <div>
                                        <h2 className="text-5xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-white to-zinc-400">{selectedPlanet.name}</h2>
                                        <p className="text-sm text-indigo-400 uppercase tracking-[0.2em] font-bold mt-2">{selectedPlanet.type}</p>
                                    </div>
                                    <button onClick={() => setSelectedPlanet(null)} className="p-2 bg-white/5 hover:bg-white/20 rounded-full transition-colors"><X size={24}/></button>
                                </div>
                                <div className="space-y-8">
                                    <div className="relative group">
                                        <div className="absolute -inset-1 bg-gradient-to-r from-indigo-500 to-purple-600 rounded-2xl blur opacity-20 group-hover:opacity-40 transition duration-1000"></div>
                                        <div className="relative p-6 bg-zinc-900/90 rounded-xl border border-white/10 text-md leading-relaxed text-zinc-300 shadow-xl">{selectedPlanet.narration}</div>
                                    </div>
                                    <div>
                                        <h3 className="text-xs font-bold text-zinc-500 uppercase tracking-widest mb-4 flex items-center gap-2"><Layers size={14}/> Vital Statistics</h3>
                                        <div className="grid grid-cols-2 gap-3">
                                            {Object.entries(selectedPlanet.stats).map(([k,v]) => (
                                                <div key={k} className="bg-white/5 p-4 rounded-xl border border-white/5 hover:border-white/20 transition-colors">
                                                    <div className="text-[10px] text-indigo-300 uppercase font-bold tracking-wider mb-1">{k}</div>
                                                    <div className="font-mono text-lg text-white">{v}</div>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                    <div>
                                        <h3 className="text-xs font-bold text-zinc-500 uppercase tracking-widest mb-4">Atmosphere</h3>
                                        <div className="flex gap-2 flex-wrap">
                                            {selectedPlanet.comp.map(c => <span key={c} className="px-3 py-1 bg-white/5 border border-white/10 rounded-full text-xs text-zinc-300">{c}</span>)}
                                        </div>
                                    </div>
                                    <div>
                                        <h3 className="text-xs font-bold text-zinc-500 uppercase tracking-widest mb-4 flex items-center gap-2"><MessageSquare size={14}/> Did you know?</h3>
                                        <ul className="space-y-3">
                                            {selectedPlanet.facts.map((f, i) => <li key={i} className="flex gap-3 text-sm text-zinc-400"><span className="text-indigo-500 mt-1"><ArrowRight size={14}/></span>{f}</li>)}
                                        </ul>
                                    </div>
                                </div>
                            </>
                        )}
                    </div>

                    <div className={`absolute inset-0 bg-black z-50 flex flex-col items-center justify-center transition-opacity duration-1000 pointer-events-none ${loading ? 'opacity-100' : 'opacity-0'}`}>
                        <Loader2 className="w-12 h-12 text-indigo-500 animate-spin relative z-10" />
                        <span className="text-xs uppercase tracking-[0.3em] text-zinc-500 mt-6 font-bold">Initializing Cosmos Engine...</span>
                    </div>
                </div>
            );
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>